<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanctus Videre - Authentication</title>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #121418;
            color: #e1e1e1;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .loading-container {
            text-align: center;
            padding: 2rem;
            background-color: #1e2124;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 400px;
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3e67b9;
            width: 40px;
            height: 40px;
            margin: 1rem auto;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h1 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        
        p {
            margin-bottom: 0;
            color: #aaa;
        }
        
        .error-message {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-top: 1rem;
        }
        
        button {
            background-color: #3e67b9;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-top: 1rem;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }
        
        button:hover {
            background-color: #2d4b8a;
        }
    </style>
</head>
<body>
    <div class="loading-container">
        <h1>Sanctus Videre</h1>
        <div class="loading-spinner" id="spinner"></div>
        <p id="status-message">Processing authentication...</p>
        <div id="error-message" class="error-message" style="display: none;"></div>
        <button id="return-button" style="display: none;" onclick="window.location.href='/'">Return to Home</button>
    </div>

    <script>
        // Auth0 configuration
        const AUTH0_CONFIG = {
            domain: 'dev-wl2dxopsswbbvkcb.us.auth0.com',
            clientId: 'BAXPcs4GZAZodDtErS8UxTmugyxbEcZU',
            clientSecret: 'v7jTmzE6fnPxuFyguFLjIBIMDiwDmEyCV-xXkIyIOuDTb5SHltLfU9h55CjOgauc',
            redirectUri: 'https://sanctusvidere.com/callback-simple.html'
        };
        
        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // Function to show error
        function showError(message) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('status-message').textContent = 'Authentication Error';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('return-button').style.display = 'block';
        }
        
        // Process the authentication when page loads
        window.onload = function() {
            // Check for authorization code
            const code = getUrlParameter('code');
            const error = getUrlParameter('error');
            const errorDescription = getUrlParameter('error_description');
            
            if (error) {
                // Show error from Auth0
                showError(errorDescription || 'Authentication failed');
                return;
            }
            
            if (!code) {
                // No code parameter found
                showError('No authentication code found in URL');
                return;
            }
            
            // Exchange code for token using fetch
            const tokenUrl = `https://${AUTH0_CONFIG.domain}/oauth/token`;
            const tokenData = {
                grant_type: 'authorization_code',
                client_id: AUTH0_CONFIG.clientId,
                client_secret: AUTH0_CONFIG.clientSecret,
                code: code,
                redirect_uri: AUTH0_CONFIG.redirectUri
            };
            
            // Get token from Auth0
            fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(tokenData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error_description || 'Failed to get access token');
                }
                
                // Save tokens
                localStorage.setItem('userToken', data.access_token);
                
                // Get user info
                return fetch(`https://${AUTH0_CONFIG.domain}/userinfo`, {
                    headers: {
                        'Authorization': `Bearer ${data.access_token}`
                    }
                });
            })
            .then(response => response.json())
            .then(user => {
                // Save user info
                localStorage.setItem('userName', user.name || user.email.split('@')[0]);
                localStorage.setItem('userEmail', user.email);
                
                // Update status message
                document.getElementById('status-message').textContent = 'Login successful! Redirecting...';
                
                // Redirect to home page
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            })
            .catch(error => {
                showError(error.message || 'Authentication failed');
                console.error('Auth error:', error);
            });
        };
    </script>
</body>
</html>
